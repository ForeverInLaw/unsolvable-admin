# Unsolvable Group Admin Bot (Python + PostgreSQL)

Этот Python-бот предназначен для помощи администраторам Telegram в управлении группами. Он предоставляет функции для кика, мута/размута пользователей, а также для просмотра статистики активности в чате. Бот использует базу данных PostgreSQL для хранения статистики и информации о пользователях (для поиска по @username).

## Возможности

*   **Кик:** Удаление пользователя из чата (`/kick`).
*   **Мут/Ограничение:** Запрет пользователю отправлять сообщения на определенное время или навсегда (`/mute`).
*   **Размут:** Снятие ограничений с пользователя (`/unmute`).
*   **Статистика:**
    *   Отображение общей статистики сообщений в чате.
    *   Отображение количества сообщений конкретного пользователя.
    *   Топ-5 самых активных пользователей чата.
*   **Идентификация цели:** Команды могут применяться:
    *   В ответ на сообщение пользователя.
    *   По `telegram_id` пользователя.
    *   По `@username` пользователя (если бот ранее видел сообщения от этого пользователя).
*   **Контроль доступа:** Только администраторы чата могут использовать команды управления.
*   **Персистентность:** Статистика и информация о пользователях хранятся в базе данных PostgreSQL и не теряются при перезапуске бота.

## Используемые технологии

*   **Python 3.9+**
*   **python-telegram-bot (v20+)**: Асинхронная библиотека для Telegram Bot API.
*   **psycopg2-binary**: Адаптер PostgreSQL для Python.
*   **python-dotenv**: Для управления переменными окружения.
*   **PostgreSQL**: Реляционная база данных для хранения данных.

## Предварительные требования

1.  **Python**: Установленный Python версии 3.9 или выше.
2.  **PostgreSQL**: Работающий сервер PostgreSQL (локально или удаленно).
3.  **pip**: Менеджер пакетов Python (обычно идет в комплекте с Python).
4.  **Git**: Система контроля версий (опционально, для клонирования репозитория).

## Установка и Настройка

1.  **Клонируйте репозиторий (или скачайте файлы):**
    ```bash
    git clone https://github.com/ForeverInLaw/unsolvable-admin
    cd unsolvable-admin
    ```

2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    # Windows
    venv\Scripts\activate
    # Linux/macOS
    source venv/bin/activate
    ```

3.  **Установите зависимости:**
    Создайте файл `requirements.txt` со следующим содержимым:
    ```txt
    python-telegram-bot[ext]>=20.0 # Установка с расширениями
    psycopg2-binary
    python-dotenv
    ```
    Затем выполните:
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте базу данных PostgreSQL:**
    *   Подключитесь к вашему серверу PostgreSQL.
    *   Создайте базу данных для бота:
        ```sql
        CREATE DATABASE telegram_admin_bot_db;
        ```
    *   Создайте пользователя для бота (замените `'your_secure_password'` на надежный пароль):
        ```sql
        CREATE USER bot_user WITH PASSWORD 'your_secure_password';
        ```
    *   Предоставьте пользователю права на созданную базу данных:
        ```sql
        GRANT ALL PRIVILEGES ON DATABASE telegram_admin_bot_db TO bot_user;
        ```
    *   *(Опционально, если нужна работа в конкретной схеме)*:
        ```sql
        -- Подключитесь к базе \c telegram_admin_bot_db
        GRANT ALL ON SCHEMA public TO bot_user;
        ```

5.  **Настройте переменные окружения:**
    Создайте файл с именем `.env` в корневой папке проекта и заполните его вашими данными:
    ```dotenv
    # Токен вашего Telegram бота (получить у @BotFather)
    BOT_TOKEN="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"

    # Настройки подключения к PostgreSQL
    DB_NAME="telegram_admin_bot_db"
    DB_USER="bot_user"
    DB_PASSWORD="your_secure_password"
    DB_HOST="localhost" # или IP/хост вашего сервера БД
    DB_PORT="5432"      # стандартный порт PostgreSQL
    ```
    **ВАЖНО:** Не добавляйте файл `.env` в систему контроля версий (Git), чтобы случайно не опубликовать ваши учетные данные. Добавьте `.env` в ваш файл `.gitignore`.

6.  **Получите токен Telegram бота:**
    *   Откройте Telegram и найдите бота `@BotFather`.
    *   Отправьте команду `/newbot`.
    *   Следуйте инструкциям, чтобы задать имя и username для вашего бота.
    *   @BotFather предоставит вам **HTTP API токен**. Скопируйте его и вставьте в переменную `BOT_TOKEN` в файле `.env`.

7.  **Добавьте бота в ваш групповой чат:**
    *   Найдите вашего бота в Telegram по его username.
    *   Откройте ваш групповой чат.
    *   Перейдите в Настройки группы -> Администраторы -> Добавить администратора.
    *   Найдите вашего бота и добавьте его.
    *   Предоставьте боту необходимые права. Минимум:
        *   **Блокировка участников** (для `/kick`, `/mute`, `/unmute`).
        *   *(Рекомендуется)* Удаление сообщений.
        *   *(Рекомендуется)* Пригласительные ссылки (если планируете добавлять функции).
    *   **Важно:** Бот должен быть администратором, чтобы иметь возможность управлять другими участниками (кроме других администраторов) и запрашивать список администраторов чата.

## Запуск бота

1.  Убедитесь, что ваше виртуальное окружение активировано.
2.  Убедитесь, что ваш сервер PostgreSQL запущен и доступен.
3.  Запустите бота из корневой папки проекта:
    ```bash
    python main.py
    ```
4.  Бот подключится к Telegram и базе данных. При первом запуске он создаст необходимые таблицы в БД. Следите за логами в консоли на предмет ошибок.

## Использование

Команды могут использовать только администраторы чата, в котором находится бот.

*   `/help` - Показать это справочное сообщение.
*   `/start` - Приветственное сообщение (в основном для личного чата с ботом).
*   `/kick <цель>` - Кикнуть пользователя.
*   `/mute <цель> [время]` - Замутить пользователя.
    *   `[время]` - необязательный параметр. Формат: `5m` (минуты), `1h` (часы), `2d` (дни).
    *   Если время не указано, мут будет навсегда.
*   `/unmute <цель>` - Размутить пользователя.
*   `/stat [цель]` - Показать статистику.
    *   Без цели: общая статистика чата и топ-5 пользователей.
    *   С целью: статистика сообщений указанного пользователя.

**`<цель>` может быть указана одним из следующих способов:**

1.  **Ответ на сообщение:** Отправьте команду в ответ на сообщение пользователя, которого хотите кикнуть/замутить/размутить/посмотреть статистику.
2.  **User ID:** Укажите числовой ID пользователя после команды (например, `/mute 123456789 1h`).
3.  **@username:** Укажите `@username` пользователя после команды (например, `/stat @username`). **Важно:** Этот способ работает, только если бот ранее видел сообщения от пользователя с этим `@username` и сохранил его в своей базе данных.

## Схема Базы Данных

Бот использует две основные таблицы:

1.  `users`:
    *   `user_id` (BIGINT, PK): Уникальный ID пользователя Telegram.
    *   `username` (TEXT, Nullable): Последний известный username пользователя.
    *   `first_name` (TEXT): Имя пользователя.
    *   `last_name` (TEXT, Nullable): Фамилия пользователя.
    *   `last_seen` (TIMESTAMPTZ): Время последнего сообщения от пользователя, увиденного ботом.
2.  `user_chat_stats`:
    *   `chat_id` (BIGINT, PK): ID чата Telegram.
    *   `user_id` (BIGINT, PK, FK -> users): ID пользователя.
    *   `message_count` (INTEGER): Количество сообщений пользователя в данном чате.
    *   `last_message_timestamp` (TIMESTAMPTZ): Время последнего сообщения пользователя в данном чате.

## Известные ограничения

*   Бот не может кикать, мутить или размучивать других администраторов или владельца чата.
*   Статистика сообщений собирается только с момента первого успешного запуска бота с подключенной базой данных. Сообщения до этого момента не учитываются.
*   Поиск пользователя по `@username` работает только для тех пользователей, от которых бот уже получал сообщения и успел сохранить их данные в БД. Если пользователь сменил `@username`, бот найдет его по новому `@username` только после получения нового сообщения.

## Возможные улучшения

*   Добавление команд для предупреждений (warn/unwarn).
*   Добавление команды для бана/разбана (в дополнение к кику).
*   Более гибкая настройка прав (какие команды доступны каким админам).
*   Использование вебхуков вместо поллинга для большей эффективности.
*   Более детальная статистика (по типам сообщений, по времени суток и т.д.).
*   Очистка старых данных из БД.
*   Переход на асинхронный драйвер PostgreSQL (например, `asyncpg`) для повышения производительности.
